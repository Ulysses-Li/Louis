<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Helix Drill (智慧參數版)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- <link rel="stylesheet" href="css/base.css">
  <link rel="stylesheet" href="css/header.css">
  <link rel="stylesheet" href="css/sections.css">
  <link rel="stylesheet" href="css/product-card.css">
  <link rel="stylesheet" href="css/hover-effects.css">
  <link rel="stylesheet" href="css/footer.css" /> -->

  <link rel="stylesheet" href="https://ulysses-li.github.io/Nine-9/Helix/css/base.css">
  <link rel="stylesheet" href="https://ulysses-li.github.io/Nine-9/Helix/css/header.css">
  <link rel="stylesheet" href="https://ulysses-li.github.io/Nine-9/Helix/css/sections.css">
  <link rel="stylesheet" href="https://ulysses-li.github.io/Nine-9/Helix/css/product-card.css">
  <link rel="stylesheet" href="https://ulysses-li.github.io/Nine-9/Helix/css/hover-effects.css">
  <link rel="stylesheet" href="https://ulysses-li.github.io/Nine-9/Helix/css/footer.css" />

</head>

<body>

  <nav class="navbar navbar-expand-lg bg-body-tertiary sticky-top" aria-label="主選單" data-i18n-attrs="aria-label"
    data-i18n-aria-label="nav.main">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center" href="#" aria-label="Home" data-i18n-attrs="aria-label"
        data-i18n-aria-label="nav.home">
        <img src="https://nine9.jic-tools.com.tw/themes/nine9/images/logo.png" alt="Nine9">
      </a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav"
        aria-controls="mainNav" aria-expanded="false" aria-label="Toggle navigation" data-i18n-attrs="aria-label"
        data-i18n-aria-label="nav.toggle">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="mainNav">
        <h1 data-i18n="helix.title">NC Helix Drill</h1>

        <div class="tab-content d-flex align-items-center gap-2 ms-auto">
          <button class="icon-btn" aria-label="Search" data-i18n-attrs="aria-label" data-i18n-aria-label="nav.search">
            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" viewBox="0 0 16 16"
              aria-hidden="true">
              <path
                d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85zm-5.242.656a5 5 0 1 1 0-10 5 5 0 0 1 0 10z" />
            </svg>
          </button>

          <div class="dropdown dropdown-hover">
            <button class="btn btn-outline-secondary dropdown-toggle d-flex align-items-center" type="button"
              id="langMenuBtn" data-bs-toggle="dropdown" data-bs-auto-close="outside" aria-expanded="false">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="me-2"
                viewBox="0 0 16 16" aria-hidden="true">
                <path
                  d="M0 8a8 8 0 1 0 16 0A8 8 0 0 0 0 8m8-7a7 7 0 0 1 6.468 4H8zM1.532 5A7 7 0 0 1 8 1v4zM7 6v4H1.07A6.97 6.97 0 0 1 1 8c0-.69.099-1.356.284-1.988zM8 11v4a7 7 0 0 1-6.468-4zM9 11h5.93A6.97 6.97 0 0 1 15 8c0-.69-.099-1.356-.284-1.988H9zM15 8a7 7 0 0 1-6 6.93V10z" />
              </svg>
              <span data-i18n="nav.lang">Language/Region</span>
            </button>
            <div class="dropdown-menu mega dropdown-menu-end shadow" aria-labelledby="langMenuBtn">
              <div class="container-fluid px-2">
                <div class="row g-3">
                  <div class="col-12 col-lg-6 country-col">
                    <h6 data-i18n="nav.region.apac">Asia / Pacific</h6>
                    <a class="country-item" href="#" data-lang="zh-TW"><img class="country-flag"
                        src="https://flagcdn.com/tw.svg" alt="Taiwan flag"><span>台灣（繁體中文）</span></a>
                    <a class="country-item" href="#" data-lang="ja-JP"><img class="country-flag"
                        src="https://flagcdn.com/jp.svg" alt="Japan flag"><span>日本</span></a>
                    <a class="country-item disabled" href="#" data-lang="zh-CN" aria-disabled="true" title="暫不提供"><img
                        class="country-flag" src="https://flagcdn.com/cn.svg" alt="China flag"><span>中国（简体中文）</span></a>
                  </div>
                  <div class="col-12 col-lg-6 country-col">
                    <h6 data-i18n="nav.region.americas_europe">Americas & Europe</h6>
                    <a class="country-item" href="#" data-lang="en-US"><img class="country-flag"
                        src="https://flagcdn.com/us.svg" alt="USA flag"><span>USA</span></a>
                    <a class="country-item" href="#" data-lang="de-DE"><img class="country-flag"
                        src="https://flagcdn.com/de.svg" alt="Germany flag"><span>Deutschland</span></a>
                    <a class="country-item" href="#" data-lang="es-ES"><img class="country-flag"
                        src="https://flagcdn.com/es.svg" alt="Spain flag"><span>España</span></a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <section class="">
    <div class="container my-3">
      <div class="row">

        <div class="col-md-6">
          <div class="row g-3">

            <div class="col-12">
              <div class="card shadow-sm">
                <div class="card-body">
                  <h5 class="card-title mb-3 fw-bold" data-i18n="form.partNo.title">Select Part No.</h5>
                  <div class="row g-3">
                    <div class="col-md-6">
                      <label for="partsGroup1" class="form-label fw-bold" data-i18n="form.partNo.group1">Part No. (99321
                        Series)</label>
                      <select id="partsGroup1" class="form-select" onchange="onPartSelect(this)">
                        <option value="" selected disabled data-i18n="form.common.select">Please select...</option>
                        <option>00-99321-010-1320</option>
                        <option>00-99321-012-1525</option>
                        <option>00-99321-016-2030</option>
                        <option>00-99321-020-2540</option>
                        <option>00-99321-025-3050</option>
                        <option>00-99321-025-4265</option>

                      </select>
                    </div>
                    <div class="col-md-6">
                      <label for="partsGroup2" class="form-label fw-bold" data-i18n="form.partNo.group2">Part No. (99323
                        Series)</label>
                      <select id="partsGroup2" class="form-select" onchange="onPartSelect(this)">
                        <option value="" selected disabled data-i18n="form.common.select">Please select...</option>
                        <option>00-99323-010-1320</option>
                        <option>00-99323-012-1525</option>
                        <option>00-99323-016-2030</option>
                        <option>00-99323-020-2540</option>
                        <option>00-99323-025-3050</option>
                      </select>
                    </div>
                  </div>
                  <div class="mt-3 muted" id="pickedPartInfo" data-i18n="form.partNo.status.none">No Part No. selected.
                  </div>


                  <div class="mt-3 d-none" id="extensionBarBlock">
                    <label class="form-label fw-bold" data-i18n="form.partNo.extBarLabel">Extension Bar</label>
                    <select id="extensionBarSelect" class="form-select">
                      <option value="" selected disabled data-i18n="form.common.select">Please select...</option>
                    </select>
                    <div id="extensionBarStatus" class="mt-2 text-muted" data-i18n="form.partNo.extBarStatus.none">
                      No extension bar selected.
                    </div>
                  </div>

                </div>
              </div>
            </div>

            <hr class="my-4" />

            <div class="col-12">
              <div class="row g-3 align-items-start">
                <div class="col-md-6 fw-bold">
                  <label class="form-label" data-i18n="form.material.label">Workpiece material</label>
                  <select class="form-select" id="selectMaterial" onchange="updateSelectColor()">
                    <option value="" disabled selected data-i18n="form.common.select">Select material</option>
                    <option value="Material01" data-group="P" data-color="#0066CC"
                      style="background-color:#0066CC;color:white;font-weight:bold;">P — Carbon steel C&lt;0.3%</option>
                    <option value="Material02" data-group="P" data-color="#0066CC"
                      style="background-color:#0066CC;color:white;font-weight:bold;">P — Carbon steel C&gt;0.3%</option>
                    <option value="Material03" data-group="P" data-color="#0066CC"
                      style="background-color:#0066CC;color:white;font-weight:bold;">P — Low alloy steel C&lt;0.3%
                    </option>
                    <option value="Material04" data-group="P" data-color="#0066CC"
                      style="background-color:#0066CC;color:white;font-weight:bold;">P — High alloy steel</option>
                    <option value="Material06" data-group="M" data-color="#FFC000"
                      style="background-color:#FFC000;font-weight:bold;">M — Stainless steel</option>
                    <option value="Material07" data-group="K" data-color="#FF0000"
                      style="background-color:#FF0000;color:white;font-weight:bold;">K — Cast iron</option>
                    <option value="Material08" data-group="N" data-color="#00B050"
                      style="background-color:#00B050;color:white;font-weight:bold;">N — Al, Al-alloys</option>
                    <option value="Material09" data-group="N" data-color="#00B050"
                      style="background-color:#00B050;color:white;font-weight:bold;">N — Cu, Cu-alloy, casting Cu-alloy
                    </option>
                    <option value="Material10" data-group="S" data-color="#E6007E"
                      style="background-color:#E6007E;color:white;font-weight:bold;">S — Heat resistant alloy</option>
                    <option value="Material11" data-group="S" data-color="#E6007E"
                      style="background-color:#E6007E;color:white;font-weight:bold;">S — Ti, Ti-alloy</option>
                    <option value="Material12" data-group="H" data-color="#A6A6A6"
                      style="background-color:#A6A6A6;font-weight:bold;">H — Hardened steel &lt; HRC50</option>
                  </select>
                  <small class="text-muted d-block muted mb-4 my-2" id="materialHint">ISO group: –</small>

                  <label class="form-label" data-i18n="form.power.label">Spindle Power</label>
                  <select class="form-select" id="selectPower">
                    <option value="low" selected data-i18n="form.power.low">&lt; 12 KW (Low / Conservative)</option>
                    <option value="medium" data-i18n="form.power.medium">12-20 KW (Medium)</option>
                    <option value="high" data-i18n="form.power.high">&gt; 20 KW (High)</option>
                  </select>
                </div>

                <div class="col-md-6 fw-bold">
                  <div class="btn-group w-100 mb-2" role="group" aria-label="Modes">
                    <button type="button" class="btn btn-primary mode-btn" data-mode="Mode1"
                      data-i18n="form.mode.mode1">Mode1</button>
                    <button type="button" class="btn btn-outline-primary mode-btn" data-mode="Mode2"
                      data-i18n="form.mode.mode2">Mode2</button>
                    <button type="button" class="btn btn-outline-primary mode-btn" data-mode="Mode3"
                      data-i18n="form.mode.mode3">Mode3</button>
                  </div>

                  <div class="card shadow-sm" id="imgCard">
                    <div class="card-body d-flex justify-content-center align-items-center" style="min-height:220px;">
                      <img id="galleryImg"
                        src="https://nine9.jic-tools.com.tw/upload_files/technology/NC_Helix_Drill/icon_helix_fig.01.jpg"
                        class="img-fluid rounded" alt="preview">

                    </div>

                  </div>
                </div>
              </div>
            </div>

            <hr class="my-4" />

            <div class="col-12">
              <div class="row g-3 align-items-start">
                <div id="group1" class="col-md-6">

                  <label class="form-label fw-bold" data-i18n="form.params.machiningDia">Machining Diameter</label>
                  <div class="input-group mb-2">
                    <input type="number" class="form-control" id="machiningDia1" placeholder="Ød1 / mm" step="0.1"
                      oninput="updateSuggestedParameters()">
                    <button type="button"
                      class="btn btn-light btn-sm border-success text-success fw-bold px-5 py-1 btn-ce"
                      id="machiningDiaCe1" data-i18n="form.common.clear">Clear</button>
                  </div>

                  <label class="form-label fw-bold" data-i18n="form.params.depth">Depth of Cut</label>
                  <div class="input-group mb-2">
                    <input type="number" class="form-control" id="depthDia1" placeholder="L1 / mm" step="0.001">
                    <button type="button"
                      class="btn btn-light btn-sm border-success text-success fw-bold px-5 py-1 btn-ce" id="depthDiaCe1"
                      data-i18n="form.common.clear">Clear</button>
                  </div>

                  <label class="form-label fw-bold" data-i18n="form.params.pitch">Pitch</label>
                  <div class="input-group mb-2">
                    <input type="number" class="form-control" id="pitch1" placeholder="P1 / mm" step="0.1"
                      oninput="this.classList.remove('is-suggested')">
                    <button type="button"
                      class="btn btn-light btn-sm border-success text-success fw-bold px-5 py-1 btn-ce" id="pitchCe1"
                      data-i18n="form.common.clear">Clear</button>
                  </div>
                </div>

                <div id="group2" class="col-md-6 d-none">

                  <label class="form-label fw-bold" data-i18n="form.params.machiningDia">Machining Diameter</label>
                  <div class="input-group mb-2">
                    <input type="number" class="form-control" id="machiningDia2" placeholder="Ød2 / mm" step="0.1"
                      oninput="updateSuggestedParameters()">
                    <button type="button"
                      class="btn btn-light btn-sm border-success text-success fw-bold px-5 py-1 btn-ce"
                      id="machiningDiaCe2" data-i18n="form.common.clear">Clear</button>
                  </div>

                  <label class="form-label fw-bold" data-i18n="form.params.depth">Depth of Cut</label>
                  <div class="input-group mb-2">
                    <input type="number" class="form-control" id="depthDia2" placeholder="L2 / mm" step="0.001">
                    <button type="button"
                      class="btn btn-light btn-sm border-success text-success fw-bold px-5 py-1 btn-ce" id="depthDiaCe2"
                      data-i18n="form.common.clear">Clear</button>
                  </div>

                  <label class="form-label fw-bold" data-i18n="form.params.pitch">Pitch</label>
                  <div class="input-group mb-2">
                    <input type="number" class="form-control" id="pitch2" placeholder="P2 / mm" step="0.1"
                      oninput="this.classList.remove('is-suggested')">
                    <button type="button"
                      class="btn btn-light btn-sm border-success text-success fw-bold px-5 py-1 btn-ce" id="pitchCe2"
                      data-i18n="form.common.clear">Clear</button>
                  </div>
                </div>

                <!-- group3：版型與 group1 完全相同，預設隱藏 -->
                <div id="group3" class="col-12 d-none">
                  <label class="form-label fw-bold" data-i18n="form.params.preBore">Pre-bore diameter</label>
                  <div class="input-group mb-2">
                    <input type="number" class="form-control" id="preBore3" data-i18n-placeholder="form.placeholders.mm"
                      step="0.001">
                    <button type="button"
                      class="btn btn-light btn-sm border-success text-success fw-bold px-5 py-1 btn-ce" id="preBoreCe3"
                      data-i18n="form.common.clear">Clear</button>
                  </div>

                  <label class="form-label fw-bold" data-i18n="form.params.machiningDia">Machining Diameter</label>
                  <div class="input-group mb-2">
                    <input type="number" class="form-control" id="machiningDia3" placeholder="Ød3 / mm" step="0.1"
                      oninput="updateSuggestedParameters_forActiveMode()">
                    <button type="button"
                      class="btn btn-light btn-sm border-success text-success fw-bold px-5 py-1 btn-ce"
                      id="machiningDiaCe3" data-i18n="form.common.clear">Clear</button>
                  </div>

                  <label class="form-label fw-bold" data-i18n="form.params.depth">Depth of Cut</label>
                  <div class="input-group mb-2">
                    <input type="number" class="form-control" id="depthDia3" placeholder="L3 / mm" step="0.001">
                    <button type="button"
                      class="btn btn-light btn-sm border-success text-success fw-bold px-5 py-1 btn-ce" id="depthDiaCe3"
                      data-i18n="form.common.clear">Clear</button>
                  </div>

                  <label class="form-label fw-bold" data-i18n="form.params.pitch">Pitch</label>
                  <div class="input-group mb-2">
                    <input type="number" class="form-control" id="pitch3" placeholder="P3 / mm" step="0.1"
                      oninput="this.classList.remove('is-suggested')">
                    <button type="button"
                      class="btn btn-light btn-sm border-success text-success fw-bold px-5 py-1 btn-ce" id="pitchCe3"
                      data-i18n="form.common.clear">Clear</button>
                  </div>
                </div>

              </div>
            </div>

            <hr class="my-4" />

            <div class="col-12">
              <div class="row g-3">
                <!-- <div class="col-md-6 fw-bold">
                  <label class="form-label" data-i18n="form.others.toolDia">Tool Diameter ØDc</label>
                  <input type="text" class="form-control bg-light" id="toolDiameter" readonly
                    style="cursor:not-allowed;" data-i18n-placeholder="form.placeholders.selectTool"
                    oninput="updateSpindleSpeed()">
                </div> -->
                <div class="col-md-6 fw-bold">
                  <label class="form-label" data-i18n="form.others.toolDia">Tool Diameter ØDc</label>
                  <input type="text" class="form-control bg-light" id="toolDiameter" readonly
                    style="cursor:not-allowed;" data-i18n-placeholder="form.placeholders.selectTool"
                    oninput="updateSpindleSpeed()">
                </div>
                <div class="col-md-6 fw-bold">
                  <label class="form-label" data-i18n="form.others.cuttingSpeed">Cutting Speed</label>
                  <input type="number" class="form-control" id="vc" data-i18n-placeholder="form.placeholders.m_min"
                    oninput="this.classList.remove('is-suggested'); updateSpindleSpeed();" />
                </div>
                <div class="col-md-6 fw-bold">
                  <label class="form-label" data-i18n="form.others.spindleSpeed">Spindle Speed</label>
                  <input type="number" class="form-control" id="n" data-i18n-placeholder="form.placeholders.rpm"
                    readonly style="background-color:#d4edda;cursor:not-allowed;" />
                </div>
                <div class="col-md-6 fw-bold">
                  <label class="form-label" data-i18n="form.others.teeth">Number of Teeth</label>
                  <input type="number" class="form-control bg-light" style="cursor:not-allowed;" id="z" value="2"
                    readonly oninput="updateFeedRate()" />
                </div>
                <div class="col-md-6 fw-bold">
                  <label class="form-label" data-i18n="form.others.feedPerTooth">Feed per Tooth</label>
                  <input type="number" class="form-control" id="fz" data-i18n-placeholder="form.placeholders.mm_tooth"
                    step="0.001" required oninput="this.classList.remove('is-suggested'); updateFeedRate();" />
                </div>
                <div class="col-md-6 fw-bold">
                  <label class="form-label" data-i18n="form.others.feedRate">Feed Rate</label>
                  <input type="number" class="form-control" id="vf" data-i18n-placeholder="form.placeholders.mm_min"
                    readonly style="background-color:#d4edda;cursor:not-allowed;" />
                </div>


                <hr class="my-4" />

                <div class="col-md-6 fw-bold">
                  <label class="form-label" data-i18n="form.others.toolNo">Tool Number</label>
                  <input type="number" class="form-control" id="toolNo" value="99" />
                </div>

                <div class="col-md-6 fw-bold">
                  <label class="form-label" data-i18n="form.others.coorSystem">Coordinate System</label>
                  <input type="text" class="form-control" id="gcode" value="G54" />
                </div>

                <hr class="my-4" />

                <div class="col-md-6 fw-bold">
                  <label class="form-label" data-i18n="form.others.coorX">Coordinate X</label>
                  <input type="number" class="form-control" id="x" value="0" />
                </div>

                <div class="col-md-6 fw-bold">
                  <label class="form-label" data-i18n="form.others.coorY">Coordinate Y</label>
                  <input type="number" class="form-control" id="y" value="0" />
                </div>

                <div class="col-md-6 fw-bold">
                  <label class="form-label" data-i18n="form.others.safeZ">Safe Height Z</label>
                  <input type="number" class="form-control" id="zsafe" value="20" />
                </div>

                <div class="col-md-6 fw-bold">
                  <label class="form-label" data-i18n="form.others.surfaceZ">Surface Coordinate Z</label>
                  <input type="number" class="form-control" id="zsurface" value="0" />
                </div>

                <hr class="my-4" />

              </div>
            </div>
          </div>
        </div>

        <div class="col-md-6 my-3">
          <div class="right-pane-sticky">
            <div class="d-flex justify-content-end mb-2">
              <button class="btn btn-secondary me-2 fw-bold" onclick="addTool(); countClick('addTool')"
                data-i18n="form.actions.addTool">Add Tool</button>
              <button class="btn btn-primary me-2 fw-bold" onclick="calculateGCode(); countClick('calculate')"
                data-i18n="form.actions.generate">Generate</button>
              <button class="btn btn-success me-2 fw-bold" onclick="exportToFile(); countClick('export')"
                data-i18n="form.actions.export">Export</button>
              <button class="btn btn-danger fw-bold" onclick="clearOutput(); countClick('clear')"
                data-i18n="form.actions.clear">Clear</button>
            </div>
            <textarea id="result" class="form-control my-3" readonly style="height: 85vh;"></textarea>
            <div id="machiningTimeResult" class="mt-2 text-end fw-bold fs-5"></div>
          </div>
        </div>
      </div>
    </div>

    <script>


      const PART_TO_BARS = { "00-99323-010-1320": ["00-99801-10S", "00-99801-10W"], "00-99323-012-1525": ["00-99801-12S", "00-99801-12W"], "00-99323-016-2030": ["00-99801-16S", "00-99801-14W", "00-99801-16W"], "00-99323-020-2540": ["00-99801-20S", "00-99801-18W", "00-99801-20W"], "00-99323-025-3050": ["00-99801-25S", "00-99801-25W"] };
      const BAR_DB = { "00-99801-10S": { type: "", torque: "" }, "00-99801-10W": { type: "", torque: "" }, "00-99801-12S": { type: "", torque: "" }, "00-99801-12W": { type: "", torque: "" }, "00-99801-14W": { type: "", torque: "" }, "00-99801-16S": { type: "", torque: "" }, "00-99801-16W": { type: "", torque: "" }, "00-99801-18W": { type: "", torque: "" }, "00-99801-20S": { type: "", torque: "" }, "00-99801-20W": { type: "", torque: "" }, "00-99801-25S": { type: "", torque: "" }, "00-99801-25W": { type: "", torque: "" } };
      const PART_TO_DIAMETER = { "00-99321-010-1320": 11.0, "00-99323-010-1320": 11.0, "00-99321-012-1525": 13.0, "00-99323-012-1525": 13.0, "00-99321-016-2030": 17.0, "00-99323-016-2030": 17.0, "00-99321-020-2540": 22.0, "00-99323-020-2540": 22.0, "00-99321-025-3050": 27.0, "00-99323-025-3050": 27.0, "00-99321-025-4265": 33.0 };
      const PART_TO_MAX_AE = {
        "00-99321-010-1320": 10.6,
        "00-99323-010-1320": 10.6,
        "00-99321-012-1525": 12.4,
        "00-99323-012-1525": 12.4,
        "00-99321-016-2030": 16.2,
        "00-99323-016-2030": 16.2,
        "00-99321-020-2540": 20.8,
        "00-99323-020-2540": 20.8,
        "00-99321-025-3050": 25.4,
        "00-99323-025-3050": 25.4,
        "00-99321-025-4265": 31.4
      };
      const PART_TO_MIN_AE = {
        "00-99321-010-1320": 1.6,
        "00-99323-010-1320": 1.6,
        "00-99321-012-1525": 2.0,
        "00-99323-012-1525": 2.0,
        "00-99321-016-2030": 2.5,
        "00-99323-016-2030": 2.5,
        "00-99321-020-2540": 3.3,
        "00-99323-020-2540": 3.3,
        "00-99321-025-3050": 4.2,
        "00-99323-025-3050": 4.2,
        "00-99321-025-4265": 4.2
      };


      function applyInsertDiameterByPart(partNo) {
        // const td = document.getElementById('toolDiameter');
        // td.value = PART_TO_DIAMETER[partNo]?.toFixed(1) || '';
        // if (typeof updateSpindleSpeed === 'function') { try { updateSpindleSpeed(); } catch (e) { } }

        const td = document.getElementById('toolDiameter');
        td.value = PART_TO_DIAMETER[partNo]?.toFixed(1) || '';
        // if (typeof updateSpindleSpeed === 'function') { try { updateSpindleSpeed(); } catch (e) { } }
      }

      // ... 您的 buildExtensionOptions, hideExtensionBar, updateUIByPart ...
      function buildExtensionOptions(partNo) {
        const extSelect = document.getElementById('extensionBarSelect');
        const allowed = PART_TO_BARS[partNo] || Object.keys(BAR_DB);
        extSelect.innerHTML = `<option value="" selected disabled>${LangCtl.get('form.common.select')}</option>`;
        allowed.forEach(code => {
          const meta = BAR_DB[code] || { type: "", torque: "" };
          const opt = document.createElement('option');
          opt.value = code; opt.dataset.type = meta.type; opt.dataset.torque = meta.torque;
          const label = [code]; if (meta.type) label.push(meta.type); if (meta.torque) label.push(`Torque: ${meta.torque}`);
          opt.textContent = label.join(' | ');
          extSelect.appendChild(opt);
        });
      }
      function hideExtensionBar() {
        document.getElementById('extensionBarBlock').classList.add('d-none');
        document.getElementById('extensionBarSelect').innerHTML = `<option value="" selected disabled>${LangCtl.get('form.common.select')}</option>`;
        const extStatus = document.getElementById('extensionBarStatus');
        extStatus.textContent = LangCtl.get('form.partNo.extBarStatus.none');
        extStatus.className = 'mt-2 text-muted';
      }
      function updateUIByPart(partNo) {
        applyInsertDiameterByPart(partNo);
        if (!/^00-99323-/.test(partNo)) { hideExtensionBar(); return; }
        const extBlock = document.getElementById('extensionBarBlock');
        const extStatus = document.getElementById('extensionBarStatus');
        buildExtensionOptions(partNo);
        extBlock.classList.remove('d-none');
        extStatus.textContent = LangCtl.get('form.partNo.extBarStatus.none');
        extStatus.className = 'mt-2 text-muted';
      }

      // 您的 extensionBarSelect 事件 (保持不變)
      // document.getElementById('extensionBarSelect').addEventListener('change', function () {
      //   const opt = this.options[this.selectedIndex];
      //   const status = document.getElementById('extensionBarStatus');
      //   if (opt && opt.value) {
      //     const bits = [opt.value, opt.dataset.type, opt.dataset.torque && `Torque: ${opt.dataset.torque}`].filter(Boolean);
      //     status.textContent = `${LangCtl.get('form.partNo.extBarStatus.selected')}: ${bits.join(' | ')}`;
      //     status.className = 'mt-2 fw-bold text-success';
      //   } else {
      //     status.textContent = LangCtl.get('form.partNo.extBarStatus.none');
      //     status.className = 'mt-2 text-muted';
      //   }
      // });
      const extSel = document.getElementById('extensionBarSelect');
      if (extSel) {
        extSel.addEventListener('change', function () {
          const opt = this.options[this.selectedIndex];
          const status = document.getElementById('extensionBarStatus');
          if (opt && opt.value) {
            const bits = [opt.value, opt.dataset.type, opt.dataset.torque && `Torque: ${opt.dataset.torque}`].filter(Boolean);
            status.textContent = `${LangCtl.get('form.partNo.extBarStatus.selected')}: ${bits.join(' | ')}`;
            status.className = 'mt-2 fw-bold text-success';
          } else {
            status.textContent = LangCtl.get('form.partNo.extBarStatus.none');
            status.className = 'mt-2 text-muted';
          }
        });
      }

      // --- ▼▼▼ 修改：onPartSelect 函數 ▼▼▼ ---

      function onPartSelect(sel) {
        const g1 = document.getElementById('partsGroup1'), g2 = document.getElementById('partsGroup2'), pickedInfo = document.getElementById('pickedPartInfo');
        if (sel.id === 'partsGroup1') { g2.selectedIndex = 0; } else { g1.selectedIndex = 0; }
        const val = sel.value || sel.options[sel.selectedIndex]?.text;
        if (val) {
          pickedInfo.textContent = `${LangCtl.get('form.partNo.status.selected')}: ${val}`;
          pickedInfo.className = 'mt-3 text-success fw-bold';
        } else {
          pickedInfo.textContent = LangCtl.get('form.partNo.status.none');
          pickedInfo.className = 'mt-3 muted';
        }
        if (val) updateUIByPart(val);
        if (typeof updateCuttingSpeed === 'function') updateCuttingSpeed();
        if (typeof window.syncFzBlink === 'function') window.syncFzBlink();
      }

      // --- ▲▲▲ 修改：onPartSelect 函數 ▲▲▲ ---
    </script>

    <script>
      function updateSelectColor() {
        const sel = document.getElementById('selectMaterial'), opt = sel.options[sel.selectedIndex];
        if (!opt) return;
        const color = opt.dataset.color || '', group = opt.dataset.group || '';
        sel.style.backgroundColor = color;
        sel.style.color = ['#0066CC', '#FF0000', '#00B050', '#E6007E'].includes(color) ? '#fff' : '#000';
        document.getElementById('materialHint').textContent = group ? `${LangCtl.get('form.material.isoHint', 'ISO group')}: ${group}` : `${LangCtl.get('form.material.isoHint', 'ISO group')}: –`;

        updateSuggestedParameters(); // ★ 在此處觸發新函數
      }
      // ▼▼▼ 修改：將 updateCuttingSpeed() 呼叫移到 updateSelectColor 內部 ▼▼▼
      document.addEventListener('DOMContentLoaded', () => { updateSelectColor(); });
      // ▲▲▲ 修改 ▲▲▲
    </script>

    <script>
      // 您的舊 Vc 資料 (保留用於 fallback)
      const cuttingSpeedMapBySeries = { "99321": { Material01: { vc: 120 }, Material02: { vc: 100 }, Material03: { vc: 70 }, Material04: { vc: 60 }, Material06: { vc: 60 }, Material07: { vc: 70 }, Material08: { vc: 350 }, Material09: { vc: 200 }, Material10: { vc: 20 }, Material11: { vc: 40 }, Material12: { vc: 60 } }, "99323": { Material01: { vc: 200 }, Material02: { vc: 150 }, Material03: { vc: 120 }, Material04: { vc: 90 }, Material06: { vc: 90 }, Material07: { vc: 120 }, Material08: { vc: 500 }, Material09: { vc: 400 }, Material10: { vc: 30 }, Material11: { vc: 60 }, Material12: { vc: 90 } } };

      // 輔助函數：取得目前選中的 PartNo
      function getSelectedPartNo() { return document.getElementById('partsGroup2').value || document.getElementById('partsGroup1').value || ""; }
      // 輔助函數：取得 99321 or 99323
      function getSeriesFromPart(partNo) { if (/^00-99323-/.test(partNo)) return "99323"; if (/^00-99321-/.test(partNo)) return "99321"; return null; }

      // --- ▼▼▼ 新增：智慧參數資料庫 (根據 image_fa2aba.png) ▼▼▼ ---

      // --- ▼▼▼ 智慧參數資料庫（合併所有群組；避免重複宣告） ▼▼▼ ---
      window.CUTTING_DB = Object.assign(window.CUTTING_DB || {}, {
        "group_010-1320": {
          "Material01": { "vc_99321": 120, "vc_99323": 200, "grade": "NC2032", "O13": { "fz": 0.025, "pitch": { "low": 0.60, "medium": 0.80, "high": 1.00 } }, "O16": { "fz": 0.055, "pitch": { "low": 0.90, "medium": 1.20, "high": 1.50 } }, "O20": { "fz": 0.08, "pitch": { "low": 1.20, "medium": 1.60, "high": 2.00 } } },
          "Material02": { "vc_99321": 100, "vc_99323": 150, "grade": "NC5075", "O13": { "fz": 0.025, "pitch": { "low": 0.60, "medium": 0.75, "high": 0.90 } }, "O16": { "fz": 0.05, "pitch": { "low": 0.80, "medium": 1.10, "high": 1.35 } }, "O20": { "fz": 0.07, "pitch": { "low": 1.00, "medium": 1.40, "high": 1.80 } } },
          "Material03": { "vc_99321": 70, "vc_99323": 120, "grade": "NC5072", "O13": { "fz": 0.02, "pitch": { "low": 0.50, "medium": 0.65, "high": 0.80 } }, "O16": { "fz": 0.05, "pitch": { "low": 0.70, "medium": 0.95, "high": 1.20 } }, "O20": { "fz": 0.06, "pitch": { "low": 1.00, "medium": 1.30, "high": 1.60 } } },
          "Material04": { "vc_99321": 60, "vc_99323": 90, "grade": "NC5075", "O13": { "fz": 0.02, "pitch": { "low": 0.50, "medium": 0.65, "high": 0.80 } }, "O16": { "fz": 0.05, "pitch": { "low": 0.70, "medium": 0.95, "high": 1.20 } }, "O20": { "fz": 0.06, "pitch": { "low": 1.00, "medium": 1.30, "high": 1.60 } } },
          "Material06": { "vc_99321": 60, "vc_99323": 90, "grade": "NC5072", "O13": { "fz": 0.02, "pitch": { "low": 0.50, "medium": 0.65, "high": 0.80 } }, "O16": { "fz": 0.05, "pitch": { "low": 0.70, "medium": 0.95, "high": 1.20 } }, "O20": { "fz": 0.06, "pitch": { "low": 1.00, "medium": 1.30, "high": 1.60 } } },
          "Material07": { "vc_99321": 70, "vc_99323": 120, "grade": "NC2032", "O13": { "fz": 0.025, "pitch": { "low": 0.60, "medium": 0.80, "high": 1.00 } }, "O16": { "fz": 0.055, "pitch": { "low": 0.90, "medium": 1.20, "high": 1.50 } }, "O20": { "fz": 0.08, "pitch": { "low": 1.20, "medium": 1.60, "high": 2.00 } } },
          "Material08": { "vc_99321": 350, "vc_99323": 500, "grade": "NC2032", "O13": { "fz": 0.025, "pitch": { "low": 0.90, "medium": 1.20, "high": 1.50 } }, "O16": { "fz": 0.055, "pitch": { "low": 1.30, "medium": 1.80, "high": 2.25 } }, "O20": { "fz": 0.08, "pitch": { "low": 1.80, "medium": 2.40, "high": 3.00 } } },
          "Material09": { "vc_99321": 200, "vc_99323": 400, "grade": "NC2032", "O13": { "fz": 0.025, "pitch": { "low": 0.70, "medium": 0.95, "high": 1.20 } }, "O16": { "fz": 0.055, "pitch": { "low": 1.00, "medium": 1.40, "high": 1.80 } }, "O20": { "fz": 0.08, "pitch": { "low": 1.40, "medium": 1.90, "high": 2.40 } } },
          "Material10": { "vc_99321": 20, "vc_99323": 30, "grade": "NC5075", "O13": { "fz": 0.01, "pitch": { "low": 0.50, "medium": 0.65, "high": 0.80 } }, "O16": { "fz": 0.015, "pitch": { "low": 0.70, "medium": 0.95, "high": 1.20 } }, "O20": { "fz": 0.03, "pitch": { "low": 0.90, "medium": 1.30, "high": 1.60 } } },
          "Material11": { "vc_99321": 40, "vc_99323": 60, "grade": "NC5072", "O13": { "fz": 0.01, "pitch": { "low": 0.50, "medium": 0.65, "high": 0.80 } }, "O16": { "fz": 0.015, "pitch": { "low": 0.70, "medium": 0.95, "high": 1.20 } }, "O20": { "fz": 0.03, "pitch": { "low": 0.90, "medium": 1.30, "high": 1.60 } } },
          "Material12": { "vc_99321": 60, "vc_99323": 90, "grade": "NC5075", "O13": { "fz": 0.02, "pitch": { "low": 0.50, "medium": 0.65, "high": 0.80 } }, "O16": { "fz": 0.05, "pitch": { "low": 0.70, "medium": 0.95, "high": 1.20 } }, "O20": { "fz": 0.06, "pitch": { "low": 1.00, "medium": 1.30, "high": 1.60 } } }
        },
        "group_012-1525": {
          "Material01": { "vc_99321": 200, "vc_99323": 120, "grade": "NC2032", "O15": { "fz": 0.035, "pitch": { "low": 1.20, "medium": 1.60, "high": 2.00 } }, "O20": { "fz": 0.065, "pitch": { "low": 1.50, "medium": 2.00, "high": 2.50 } }, "O25": { "fz": 0.09, "pitch": { "low": 1.80, "medium": 2.40, "high": 3.00 } } },
          "Material02": { "vc_99321": 150, "vc_99323": 100, "grade": "NC5075", "O15": { "fz": 0.03, "pitch": { "low": 1.10, "medium": 1.50, "high": 1.80 } }, "O20": { "fz": 0.06, "pitch": { "low": 1.30, "medium": 1.78, "high": 2.25 } }, "O25": { "fz": 0.08, "pitch": { "low": 1.60, "medium": 2.15, "high": 2.70 } } },
          "Material03": { "vc_99321": 120, "vc_99323": 70, "grade": "NC5072", "O15": { "fz": 0.025, "pitch": { "low": 1.00, "medium": 1.30, "high": 1.60 } }, "O20": { "fz": 0.05, "pitch": { "low": 1.20, "medium": 1.60, "high": 2.00 } }, "O25": { "fz": 0.07, "pitch": { "low": 1.40, "medium": 1.90, "high": 2.40 } } },
          "Material04": { "vc_99321": 90, "vc_99323": 60, "grade": "NC5075", "O15": { "fz": 0.025, "pitch": { "low": 1.00, "medium": 1.30, "high": 1.60 } }, "O20": { "fz": 0.05, "pitch": { "low": 1.20, "medium": 1.60, "high": 2.00 } }, "O25": { "fz": 0.07, "pitch": { "low": 1.40, "medium": 1.90, "high": 2.40 } } },
          "Material06": { "vc_99321": 90, "vc_99323": 60, "grade": "NC5072", "O15": { "fz": 0.025, "pitch": { "low": 1.00, "medium": 1.30, "high": 1.60 } }, "O20": { "fz": 0.05, "pitch": { "low": 1.20, "medium": 1.60, "high": 2.00 } }, "O25": { "fz": 0.07, "pitch": { "low": 1.40, "medium": 1.90, "high": 2.40 } } },
          "Material07": { "vc_99321": 120, "vc_99323": 70, "grade": "NC2032", "O15": { "fz": 0.035, "pitch": { "low": 1.20, "medium": 1.60, "high": 2.00 } }, "O20": { "fz": 0.065, "pitch": { "low": 1.30, "medium": 1.90, "high": 2.50 } }, "O25": { "fz": 0.09, "pitch": { "low": 1.80, "medium": 2.40, "high": 3.00 } } },
          "Material08": { "vc_99321": 500, "vc_99323": 350, "grade": "NC2032", "O15": { "fz": 0.035, "pitch": { "low": 1.80, "medium": 2.00, "high": 2.20 } }, "O20": { "fz": 0.065, "pitch": { "low": 2.20, "medium": 2.98, "high": 3.75 } }, "O25": { "fz": 0.09, "pitch": { "low": 2.70, "medium": 3.60, "high": 4.30 } } },
          "Material09": { "vc_99321": 400, "vc_99323": 200, "grade": "NC2032", "O15": { "fz": 0.035, "pitch": { "low": 1.40, "medium": 1.90, "high": 2.20 } }, "O20": { "fz": 0.065, "pitch": { "low": 1.80, "medium": 2.40, "high": 3.00 } }, "O25": { "fz": 0.09, "pitch": { "low": 2.10, "medium": 2.85, "high": 3.60 } } },
          "Material10": { "vc_99321": 30, "vc_99323": 20, "grade": "NC5075", "O15": { "fz": 0.0125, "pitch": { "low": 1.00, "medium": 1.30, "high": 1.60 } }, "O20": { "fz": 0.0225, "pitch": { "low": 1.20, "medium": 1.60, "high": 2.00 } }, "O25": { "fz": 0.03, "pitch": { "low": 1.40, "medium": 1.90, "high": 2.40 } } },
          "Material11": { "vc_99321": 60, "vc_99323": 40, "grade": "NC5072", "O15": { "fz": 0.0125, "pitch": { "low": 1.00, "medium": 1.30, "high": 1.60 } }, "O20": { "fz": 0.0225, "pitch": { "low": 1.20, "medium": 1.60, "high": 2.00 } }, "O25": { "fz": 0.03, "pitch": { "low": 1.40, "medium": 1.90, "high": 2.40 } } },
          "Material12": { "vc_99321": 90, "vc_99323": 60, "grade": "NC5075", "O15": { "fz": 0.025, "pitch": { "low": 1.00, "medium": 1.30, "high": 1.60 } }, "O20": { "fz": 0.05, "pitch": { "low": 1.20, "medium": 1.60, "high": 2.00 } }, "O25": { "fz": 0.07, "pitch": { "low": 1.40, "medium": 1.90, "high": 2.40 } } }
        },
        "group_016-2030": {
          "Material01": { "vc_99321": 200, "vc_99323": 120, "grade": "NC2032", "O20": { "fz": 0.04, "pitch": { "low": 1.80, "medium": 2.40, "high": 3.00 } }, "O25": { "fz": 0.08, "pitch": { "low": 2.10, "medium": 2.80, "high": 3.50 } }, "O30": { "fz": 0.105, "pitch": { "low": 2.40, "medium": 3.20, "high": 4.00 } } },
          "Material02": { "vc_99321": 150, "vc_99323": 100, "grade": "NC5075", "O20": { "fz": 0.035, "pitch": { "low": 1.60, "medium": 2.15, "high": 2.70 } }, "O25": { "fz": 0.07, "pitch": { "low": 1.90, "medium": 2.55, "high": 3.20 } }, "O30": { "fz": 0.09, "pitch": { "low": 2.10, "medium": 2.85, "high": 3.60 } } },
          "Material03": { "vc_99321": 120, "vc_99323": 70, "grade": "NC5072", "O20": { "fz": 0.03, "pitch": { "low": 1.40, "medium": 1.90, "high": 2.40 } }, "O25": { "fz": 0.065, "pitch": { "low": 1.60, "medium": 2.20, "high": 2.80 } }, "O30": { "fz": 0.08, "pitch": { "low": 1.90, "medium": 2.55, "high": 3.20 } } },
          "Material04": { "vc_99321": 90, "vc_99323": 60, "grade": "NC5075", "O20": { "fz": 0.03, "pitch": { "low": 1.40, "medium": 1.90, "high": 2.40 } }, "O25": { "fz": 0.065, "pitch": { "low": 1.60, "medium": 2.20, "high": 2.80 } }, "O30": { "fz": 0.08, "pitch": { "low": 1.90, "medium": 2.55, "high": 3.20 } } },
          "Material06": { "vc_99321": 90, "vc_99323": 60, "grade": "NC5072", "O20": { "fz": 0.03, "pitch": { "low": 1.40, "medium": 1.90, "high": 2.40 } }, "O25": { "fz": 0.065, "pitch": { "low": 1.60, "medium": 2.20, "high": 2.80 } }, "O30": { "fz": 0.08, "pitch": { "low": 1.90, "medium": 2.55, "high": 3.20 } } },
          "Material07": { "vc_99321": 120, "vc_99323": 70, "grade": "NC2032", "O20": { "fz": 0.04, "pitch": { "low": 1.80, "medium": 2.40, "high": 3.00 } }, "O25": { "fz": 0.08, "pitch": { "low": 2.10, "medium": 2.80, "high": 3.50 } }, "O30": { "fz": 0.105, "pitch": { "low": 2.40, "medium": 3.20, "high": 4.00 } } },
          "Material08": { "vc_99321": 500, "vc_99323": 350, "grade": "NC2032", "O20": { "fz": 0.04, "pitch": { "low": 2.70, "medium": 3.00, "high": 3.40 } }, "O25": { "fz": 0.08, "pitch": { "low": 3.10, "medium": 4.05, "high": 5.00 } }, "O30": { "fz": 0.105, "pitch": { "low": 3.60, "medium": 4.80, "high": 5.60 } } },
          "Material09": { "vc_99321": 400, "vc_99323": 200, "grade": "NC2032", "O20": { "fz": 0.04, "pitch": { "low": 2.10, "medium": 2.85, "high": 3.40 } }, "O25": { "fz": 0.08, "pitch": { "low": 2.50, "medium": 3.35, "high": 4.20 } }, "O30": { "fz": 0.105, "pitch": { "low": 2.80, "medium": 3.80, "high": 4.80 } } },
          "Material10": { "vc_99321": 30, "vc_99323": 20, "grade": "NC5075", "O20": { "fz": 0.015, "pitch": { "low": 1.40, "medium": 1.90, "high": 2.40 } }, "O25": { "fz": 0.03, "pitch": { "low": 1.60, "medium": 2.20, "high": 2.80 } }, "O30": { "fz": 0.04, "pitch": { "low": 1.90, "medium": 2.55, "high": 3.20 } } },
          "Material11": { "vc_99321": 60, "vc_99323": 40, "grade": "NC5072", "O20": { "fz": 0.015, "pitch": { "low": 1.40, "medium": 1.90, "high": 2.40 } }, "O25": { "fz": 0.03, "pitch": { "low": 1.60, "medium": 2.20, "high": 2.80 } }, "O30": { "fz": 0.04, "pitch": { "low": 1.90, "medium": 2.55, "high": 3.20 } } },
          "Material12": { "vc_99321": 90, "vc_99323": 60, "grade": "NC5075", "O20": { "fz": 0.03, "pitch": { "low": 1.40, "medium": 1.90, "high": 2.40 } }, "O25": { "fz": 0.065, "pitch": { "low": 1.60, "medium": 2.20, "high": 2.80 } }, "O30": { "fz": 0.08, "pitch": { "low": 1.90, "medium": 2.55, "high": 3.20 } } }
        },
        "group_020-2540": {
          "Material01": { "vc_99321": 200, "vc_99323": 120, "grade": "NC2032", "O25": { "fz": 0.05, "pitch": { "low": 1.80, "medium": 2.40, "high": 3.00 } }, "O32": { "fz": 0.095, "pitch": { "low": 2.40, "medium": 3.20, "high": 4.00 } }, "O40": { "fz": 0.12, "pitch": { "low": 3.00, "medium": 4.00, "high": 5.00 } } },
          "Material02": { "vc_99321": 150, "vc_99323": 100, "grade": "NC5075", "O25": { "fz": 0.04, "pitch": { "low": 1.60, "medium": 2.15, "high": 2.70 } }, "O32": { "fz": 0.08, "pitch": { "low": 2.20, "medium": 2.90, "high": 3.60 } }, "O40": { "fz": 0.11, "pitch": { "low": 2.70, "medium": 3.60, "high": 4.50 } } },
          "Material03": { "vc_99321": 120, "vc_99323": 70, "grade": "NC5072", "O25": { "fz": 0.035, "pitch": { "low": 1.40, "medium": 1.90, "high": 2.40 } }, "O32": { "fz": 0.07, "pitch": { "low": 1.90, "medium": 2.55, "high": 3.20 } }, "O40": { "fz": 0.095, "pitch": { "low": 2.40, "medium": 3.20, "high": 4.00 } } },
          "Material04": { "vc_99321": 90, "vc_99323": 60, "grade": "NC5075", "O25": { "fz": 0.035, "pitch": { "low": 1.40, "medium": 1.90, "high": 2.40 } }, "O32": { "fz": 0.07, "pitch": { "low": 1.90, "medium": 2.55, "high": 3.20 } }, "O40": { "fz": 0.095, "pitch": { "low": 2.40, "medium": 3.20, "high": 4.00 } } },
          "Material06": { "vc_99321": 90, "vc_99323": 60, "grade": "NC5072", "O25": { "fz": 0.035, "pitch": { "low": 1.40, "medium": 1.90, "high": 2.40 } }, "O32": { "fz": 0.07, "pitch": { "low": 1.90, "medium": 2.55, "high": 3.20 } }, "O40": { "fz": 0.095, "pitch": { "low": 2.40, "medium": 3.20, "high": 4.00 } } },
          "Material07": { "vc_99321": 120, "vc_99323": 70, "grade": "NC2032", "O25": { "fz": 0.05, "pitch": { "low": 1.80, "medium": 2.40, "high": 3.00 } }, "O32": { "fz": 0.095, "pitch": { "low": 2.40, "medium": 3.20, "high": 4.00 } }, "O40": { "fz": 0.12, "pitch": { "low": 3.00, "medium": 4.00, "high": 5.00 } } },
          "Material08": { "vc_99321": 500, "vc_99323": 350, "grade": "NC2032", "O25": { "fz": 0.05, "pitch": { "low": 2.70, "medium": 3.00, "high": 3.40 } }, "O32": { "fz": 0.095, "pitch": { "low": 3.60, "medium": 4.80, "high": 6.00 } }, "O40": { "fz": 0.12, "pitch": { "low": 4.50, "medium": 6.00, "high": 7.50 } } },
          "Material09": { "vc_99321": 400, "vc_99323": 200, "grade": "NC2032", "O25": { "fz": 0.05, "pitch": { "low": 2.10, "medium": 2.85, "high": 3.40 } }, "O32": { "fz": 0.095, "pitch": { "low": 2.90, "medium": 3.85, "high": 4.80 } }, "O40": { "fz": 0.12, "pitch": { "low": 3.60, "medium": 4.80, "high": 6.00 } } },
          "Material10": { "vc_99321": 30, "vc_99323": 20, "grade": "NC5075", "O25": { "fz": 0.02, "pitch": { "low": 1.40, "medium": 1.90, "high": 2.40 } }, "O32": { "fz": 0.035, "pitch": { "low": 1.90, "medium": 2.55, "high": 3.20 } }, "O40": { "fz": 0.045, "pitch": { "low": 2.40, "medium": 3.20, "high": 4.00 } } },
          "Material11": { "vc_99321": 60, "vc_99323": 40, "grade": "NC5072", "O25": { "fz": 0.02, "pitch": { "low": 1.40, "medium": 1.90, "high": 2.40 } }, "O32": { "fz": 0.035, "pitch": { "low": 1.90, "medium": 2.55, "high": 3.20 } }, "O40": { "fz": 0.045, "pitch": { "low": 2.40, "medium": 3.20, "high": 4.00 } } },
          "Material12": { "vc_99321": 90, "vc_99323": 60, "grade": "NC5075", "O25": { "fz": 0.035, "pitch": { "low": 1.40, "medium": 1.90, "high": 2.40 } }, "O32": { "fz": 0.07, "pitch": { "low": 1.90, "medium": 2.55, "high": 3.20 } }, "O40": { "fz": 0.095, "pitch": { "low": 2.40, "medium": 3.20, "high": 4.00 } } }
        },
        "group_025-3050": {
          "Material01": { "vc_99321": 200, "vc_99323": 120, "grade": "NC2032", "O30": { "fz": 0.055, "pitch": { "low": 2.40, "medium": 3.00, "high": 3.40 } }, "O40": { "fz": 0.12, "pitch": { "low": 3.00, "medium": 4.00, "high": 5.00 } }, "O50": { "fz": 0.135, "pitch": { "low": 3.60, "medium": 4.80, "high": 6.00 } } },
          "Material02": { "vc_99321": 150, "vc_99323": 100, "grade": "NC5075", "O30": { "fz": 0.05, "pitch": { "low": 2.20, "medium": 2.90, "high": 3.40 } }, "O40": { "fz": 0.10, "pitch": { "low": 2.70, "medium": 3.60, "high": 4.50 } }, "O50": { "fz": 0.12, "pitch": { "low": 3.20, "medium": 4.30, "high": 5.40 } } },
          "Material03": { "vc_99321": 120, "vc_99323": 70, "grade": "NC5072", "O30": { "fz": 0.04, "pitch": { "low": 1.90, "medium": 2.55, "high": 3.20 } }, "O40": { "fz": 0.09, "pitch": { "low": 2.40, "medium": 3.20, "high": 4.00 } }, "O50": { "fz": 0.11, "pitch": { "low": 2.90, "medium": 3.85, "high": 4.80 } } },
          "Material04": { "vc_99321": 90, "vc_99323": 60, "grade": "NC5075", "O30": { "fz": 0.04, "pitch": { "low": 1.90, "medium": 2.55, "high": 3.20 } }, "O40": { "fz": 0.09, "pitch": { "low": 2.40, "medium": 3.20, "high": 4.00 } }, "O50": { "fz": 0.11, "pitch": { "low": 2.90, "medium": 3.85, "high": 4.80 } } },
          "Material06": { "vc_99321": 90, "vc_99323": 60, "grade": "NC5072", "O30": { "fz": 0.04, "pitch": { "low": 1.90, "medium": 2.55, "high": 3.20 } }, "O40": { "fz": 0.09, "pitch": { "low": 2.40, "medium": 3.20, "high": 4.00 } }, "O50": { "fz": 0.11, "pitch": { "low": 2.90, "medium": 3.85, "high": 4.80 } } },
          "Material07": { "vc_99321": 120, "vc_99323": 70, "grade": "NC2032", "O30": { "fz": 0.055, "pitch": { "low": 2.40, "medium": 3.00, "high": 3.40 } }, "O40": { "fz": 0.115, "pitch": { "low": 3.00, "medium": 4.00, "high": 5.00 } }, "O50": { "fz": 0.135, "pitch": { "low": 3.60, "medium": 4.80, "high": 6.00 } } },
          "Material08": { "vc_99321": 500, "vc_99323": 350, "grade": "NC2032", "O30": { "fz": 0.055, "pitch": { "low": 2.50, "medium": 3.00, "high": 3.40 } }, "O40": { "fz": 0.115, "pitch": { "low": 4.50, "medium": 6.00, "high": 7.50 } }, "O50": { "fz": 0.135, "pitch": { "low": 5.40, "medium": 7.20, "high": 9.00 } } },
          "Material09": { "vc_99321": 400, "vc_99323": 200, "grade": "NC2032", "O30": { "fz": 0.055, "pitch": { "low": 2.50, "medium": 3.00, "high": 3.40 } }, "O40": { "fz": 0.115, "pitch": { "low": 3.60, "medium": 4.80, "high": 6.00 } }, "O50": { "fz": 0.135, "pitch": { "low": 4.30, "medium": 5.75, "high": 7.20 } } },
          "Material10": { "vc_99321": 30, "vc_99323": 20, "grade": "NC5075", "O30": { "fz": 0.02, "pitch": { "low": 1.90, "medium": 2.55, "high": 3.20 } }, "O40": { "fz": 0.045, "pitch": { "low": 2.40, "medium": 3.20, "high": 4.00 } }, "O50": { "fz": 0.055, "pitch": { "low": 2.90, "medium": 3.85, "high": 4.80 } } },
          "Material11": { "vc_99321": 60, "vc_99323": 40, "grade": "NC5072", "O30": { "fz": 0.02, "pitch": { "low": 1.90, "medium": 2.55, "high": 3.20 } }, "O40": { "fz": 0.045, "pitch": { "low": 2.40, "medium": 3.20, "high": 4.00 } }, "O50": { "fz": 0.055, "pitch": { "low": 2.90, "medium": 3.85, "high": 4.80 } } },
          "Material12": { "vc_99321": 90, "vc_99323": 60, "grade": "NC5075", "O30": { "fz": 0.04, "pitch": { "low": 1.90, "medium": 2.55, "high": 3.20 } }, "O40": { "fz": 0.09, "pitch": { "low": 2.40, "medium": 3.20, "high": 4.00 } }, "O50": { "fz": 0.11, "pitch": { "low": 2.90, "medium": 3.85, "high": 4.80 } } }
        },
        "group_025-4265": {
          "Material01": { "vc_99321": 200, "vc_99323": 200, "grade": "NC2032", "O42": { "fz": 0.08, "pitch": { "low": 3.00, "medium": 3.60, "high": 4.40 } }, "O55": { "fz": 0.12, "pitch": { "low": 3.30, "medium": 4.40, "high": 5.50 } }, "O65": { "fz": 0.135, "pitch": { "low": 3.60, "medium": 4.80, "high": 6.00 } } },
          "Material02": { "vc_99321": 150, "vc_99323": 150, "grade": "NC5075", "O42": { "fz": 0.075, "pitch": { "low": 2.70, "medium": 3.60, "high": 4.40 } }, "O55": { "fz": 0.11, "pitch": { "low": 3.00, "medium": 4.00, "high": 5.00 } }, "O65": { "fz": 0.12, "pitch": { "low": 3.20, "medium": 4.30, "high": 5.40 } } },
          "Material03": { "vc_99321": 120, "vc_99323": 120, "grade": "NC5072", "O42": { "fz": 0.065, "pitch": { "low": 2.40, "medium": 3.20, "high": 4.00 } }, "O55": { "fz": 0.095, "pitch": { "low": 2.60, "medium": 3.50, "high": 4.40 } }, "O65": { "fz": 0.11, "pitch": { "low": 2.90, "medium": 3.85, "high": 4.80 } } },
          "Material04": { "vc_99321": 90, "vc_99323": 90, "grade": "NC5075", "O42": { "fz": 0.065, "pitch": { "low": 2.40, "medium": 3.20, "high": 4.00 } }, "O55": { "fz": 0.095, "pitch": { "low": 2.60, "medium": 3.50, "high": 4.40 } }, "O65": { "fz": 0.11, "pitch": { "low": 2.90, "medium": 3.85, "high": 4.80 } } },
          "Material06": { "vc_99321": 90, "vc_99323": 90, "grade": "NC5072", "O42": { "fz": 0.065, "pitch": { "low": 2.40, "medium": 3.20, "high": 4.00 } }, "O55": { "fz": 0.095, "pitch": { "low": 2.60, "medium": 3.50, "high": 4.40 } }, "O65": { "fz": 0.11, "pitch": { "low": 2.90, "medium": 3.85, "high": 4.80 } } },
          "Material07": { "vc_99321": 120, "vc_99323": 120, "grade": "NC2032", "O42": { "fz": 0.08, "pitch": { "low": 3.00, "medium": 3.60, "high": 4.40 } }, "O55": { "fz": 0.12, "pitch": { "low": 3.30, "medium": 4.40, "high": 5.50 } }, "O65": { "fz": 0.135, "pitch": { "low": 3.60, "medium": 4.80, "high": 6.00 } } },
          "Material08": { "vc_99321": 500, "vc_99323": 500, "grade": "NC2032", "O42": { "fz": 0.08, "pitch": { "low": 4.00, "medium": 4.20, "high": 4.40 } }, "O55": { "fz": 0.12, "pitch": { "low": 4.90, "medium": 6.55, "high": 8.20 } }, "O65": { "fz": 0.135, "pitch": { "low": 5.40, "medium": 7.20, "high": 9.00 } } },
          "Material09": { "vc_99321": 400, "vc_99323": 400, "grade": "NC2032", "O42": { "fz": 0.08, "pitch": { "low": 3.60, "medium": 4.00, "high": 4.40 } }, "O55": { "fz": 0.12, "pitch": { "low": 4.00, "medium": 5.30, "high": 6.60 } }, "O65": { "fz": 0.135, "pitch": { "low": 4.30, "medium": 5.75, "high": 7.20 } } },
          "Material10": { "vc_99321": 30, "vc_99323": 30, "grade": "NC5075", "O42": { "fz": 0.03, "pitch": { "low": 2.40, "medium": 3.20, "high": 4.00 } }, "O55": { "fz": 0.045, "pitch": { "low": 2.60, "medium": 3.50, "high": 4.40 } }, "O65": { "fz": 0.055, "pitch": { "low": 2.90, "medium": 3.85, "high": 4.80 } } },
          "Material11": { "vc_99321": 60, "vc_99323": 60, "grade": "NC5072", "O42": { "fz": 0.03, "pitch": { "low": 2.40, "medium": 3.20, "high": 4.00 } }, "O55": { "fz": 0.045, "pitch": { "low": 2.60, "medium": 3.50, "high": 4.40 } }, "O65": { "fz": 0.055, "pitch": { "low": 2.90, "medium": 3.85, "high": 4.80 } } },
          "Material12": { "vc_99321": 90, "vc_99323": 90, "grade": "NC5075", "O42": { "fz": 0.065, "pitch": { "low": 2.40, "medium": 3.20, "high": 4.00 } }, "O55": { "fz": 0.095, "pitch": { "low": 2.60, "medium": 3.50, "high": 4.40 } }, "O65": { "fz": 0.11, "pitch": { "low": 2.90, "medium": 3.85, "high": 4.80 } } }
        }
      });
      // --- ▲▲▲ 智慧參數資料庫 ▲▲▲ ---

      // 依據 Part No. 判斷使用哪一個群組（回傳 group key 或 null）
      function getGroupKey(partNo) {
        if (!partNo) return null;
        if (partNo.includes('010-1320')) return 'group_010-1320';
        if (partNo.includes('012-1525')) return 'group_012-1525';
        if (partNo.includes('016-2030')) return 'group_016-2030';
        if (partNo.includes('020-2540')) return 'group_020-2540';
        if (partNo.includes('025-3050')) return 'group_025-3050';
        if (partNo.includes('025-4265')) return 'group_025-4265';
        return null;
      }

      // 依群組決定直徑落在哪個 O 值（回傳 materialData.Oxx）
      // replaced by generalized version above
      function getParamsForDiameter(dia, materialData, groupKey) {
        if (isNaN(dia) || !materialData || !groupKey) return null;
        switch (groupKey) {
          case 'group_010-1320': { // O13 / O16 / O20
            if (dia <= 14.5) return materialData.O13;
            if (dia <= 18.0) return materialData.O16;
            return materialData.O20;
          }
          case 'group_012-1525': { // O15 / O20 / O25
            if (dia <= 17.5) return materialData.O15;
            if (dia <= 22.5) return materialData.O20;
            return materialData.O25;
          }
          case 'group_016-2030': { // O20 / O25 / O30
            if (dia <= 22.5) return materialData.O20;
            if (dia <= 27.5) return materialData.O25;
            return materialData.O30;
          }
          case 'group_020-2540': { // O25 / O32 / O40
            if (dia <= 28.5) return materialData.O25;
            if (dia <= 36.0) return materialData.O32;
            return materialData.O40;
          }
          case 'group_025-3050': { // O30 / O40 / O50
            if (dia <= 35.0) return materialData.O30;
            if (dia <= 45.0) return materialData.O40;
            return materialData.O50;
          }
          case 'group_025-4265': { // O42 / O55 / O65
            if (dia <= 48.5) return materialData.O42;
            if (dia <= 60.5) return materialData.O55;
            return materialData.O65;
          }
        }
        return null;
      }


      // 1) 核心新函數：自動更新所有參數（支援所有群組＋Mode3）
      function updateSuggestedParameters() {
        const partNo = getSelectedPartNo();
        const groupKey = getGroupKey(partNo);
        const material = document.getElementById("selectMaterial").value;
        const power = document.getElementById("selectPower").value; // "low" | "medium" | "high"

        const dia1 = parseFloat(document.getElementById("machiningDia1")?.value);
        const dia2 = parseFloat(document.getElementById("machiningDia2")?.value);
        const dia3 = parseFloat(document.getElementById("machiningDia3")?.value);  // ★ 新增

        const vcInput = document.getElementById("vc");
        const fzInput = document.getElementById("fz");
        const pitch1Input = document.getElementById("pitch1");
        const pitch2Input = document.getElementById("pitch2");
        const pitch3Input = document.getElementById("pitch3");                     // ★ 新增

        // 清除舊樣式（含 pitch3）
        clearSuggestions();

        // 使用智慧資料庫（若群組與材料皆可用）
        if (groupKey && material && window.CUTTING_DB && window.CUTTING_DB[groupKey]) {
          const materialData = window.CUTTING_DB[groupKey][material];
          if (!materialData) {
            fallbackUpdate(partNo, material);
            updateSpindleSpeed();
            return;
          }

          // 1) Vc：依系列 99321 / 99323 取值
          const series = getSeriesFromPart(partNo);
          const vc = (series === "99323") ? materialData.vc_99323 : materialData.vc_99321;
          vcInput.value = vc ?? '';
          if (vc) vcInput.classList.add("is-suggested");

          // 2) fz 推導：優先用 Mode 對應的直徑
          //    - 若在 Mode3（或 dia1 空）就用 dia3 來推 fz；否則用 dia1
          let fzSet = false;
          if (!isNaN(dia1)) {
            const p1 = getParamsForDiameter(dia1, materialData, groupKey);
            if (p1?.fz != null) { fzInput.value = p1.fz; fzInput.classList.add("is-suggested"); fzSet = true; }
            // pitch1
            if (p1?.pitch && p1.pitch[power] != null) { pitch1Input.value = p1.pitch[power]; pitch1Input.classList.add("is-suggested"); }
          }
          if (!fzSet && !isNaN(dia3)) {                        // ★ Mode3 或 dia1 未填時，用 dia3 推 fz
            const p3_for_fz = getParamsForDiameter(dia3, materialData, groupKey);
            if (p3_for_fz?.fz != null) { fzInput.value = p3_for_fz.fz; fzInput.classList.add("is-suggested"); }
          }

          // 3) pitch2：依 Dia2 推
          if (!isNaN(dia2)) {
            const p2 = getParamsForDiameter(dia2, materialData, groupKey);
            if (p2?.pitch && p2.pitch[power] != null) {
              pitch2Input.value = p2.pitch[power];
              pitch2Input.classList.add("is-suggested");
            }
          }

          // 4) pitch3：依 Dia3 推（★ 新增）
          if (!isNaN(dia3) && pitch3Input) {
            const p3 = getParamsForDiameter(dia3, materialData, groupKey);
            if (p3?.pitch && p3.pitch[power] != null) {
              pitch3Input.value = p3.pitch[power];
              pitch3Input.classList.add("is-suggested");
            }
          }

        } else {
          // 非智慧資料庫範圍 → 舊邏輯
          fallbackUpdate(partNo, material);
        }

        // 最後更新 N / Vf
        updateSpindleSpeed();
      }

      // 2) 清除建議樣式（把 pitch3 一起列入）
      function clearSuggestions() {
        ['vc', 'fz', 'pitch1', 'pitch2', 'pitch3'].forEach(id => {
          const el = document.getElementById(id);
          if (el) el.classList.remove('is-suggested');
        });
      }

      // 3) 舊邏輯 fallback（也把 pitch3 清空邏輯補上）
      function fallbackUpdate(partNo, material) {
        const series = getSeriesFromPart(partNo) || "99321";
        const data = cuttingSpeedMapBySeries[series]?.[material];
        const vcInput = document.getElementById("vc");
        vcInput.value = data?.vc ?? "";
        if (data?.vc) vcInput.classList.add("is-suggested");

        // 清除 fz 和 pitch（若非建議狀態）
        const fz = document.getElementById("fz");
        if (fz && !fz.classList.contains('is-suggested')) fz.value = '';

        ['pitch1', 'pitch2', 'pitch3'].forEach(id => {
          const el = document.getElementById(id);
          if (el && !el.classList.contains('is-suggested')) el.value = '';
        });
      }

      // 保留舊介面
      function updateCuttingSpeed() { updateSuggestedParameters(); }
      // --- ▲▲▲ 新增：核心參數建議函數 ▲▲▲ ---
    </script>

    <script>
      // 小工具：安全取值/回填
      function getVal(id) { const el = document.getElementById(id); return el ? el.value : ''; }
      function setVal(id, v) { const el = document.getElementById(id); if (el) el.value = v; }

      // 小適配器：讓 Mode3 也能用原本的 updateSuggestedParameters() 智慧建議
      function updateSuggestedParameters_forActiveMode() {
        if (typeof updateSuggestedParameters !== 'function') return;

        const mode = (window.currentMode || 'Mode1');

        if (mode === 'Mode3') {
          // 1) 備份 group1 原值
          const backup = {
            preBore1: getVal('preBore1'),
            machiningDia1: getVal('machiningDia1'),
            depthDia1: getVal('depthDia1'),
            pitch1: getVal('pitch1'),
          };

          // 2) 用 group3 的值暫時覆寫 group1
          setVal('preBore1', getVal('preBore3'));
          setVal('machiningDia1', getVal('machiningDia3'));
          setVal('depthDia1', getVal('depthDia3'));
          setVal('pitch1', getVal('pitch3'));

          // 3) 呼叫你的智慧建議主函式
          updateSuggestedParameters();

          // 4) 把計算結果回填到 group3（fz/vc 是共用欄位已更新；這裡回填 pitch）
          setVal('pitch3', getVal('pitch1'));
          // 如需同步其他建議欄位可在此加：例 setVal('depthDia3', getVal('depthDia1'));

          // 5) 還原 group1
          setVal('preBore1', backup.preBore1);
          setVal('machiningDia1', backup.machiningDia1);
          setVal('depthDia1', backup.depthDia1);
          setVal('pitch1', backup.pitch1);
        } else {
          // Mode1 / Mode2 直接跑原本的
          updateSuggestedParameters();
        }
      }
    </script>

    <script>
      function updateSpindleSpeed() {
        const d = parseFloat(document.getElementById("toolDiameter").value), vc = parseFloat(document.getElementById("vc").value);
        document.getElementById("n").value = (!isNaN(d) && d > 0 && !isNaN(vc) && vc > 0) ? ((1000 * vc) / (Math.PI * d)).toFixed(0) : "";
        updateFeedRate();
        if (typeof window.syncFzBlink === 'function') window.syncFzBlink();
      }
      function updateFeedRate() {
        const z = parseFloat(document.getElementById("z").value), fz = parseFloat(document.getElementById("fz").value), n = parseFloat(document.getElementById("n").value);
        document.getElementById("vf").value = (!isNaN(z) && !isNaN(fz) && !isNaN(n) && z > 0 && fz > 0 && n > 0) ? (n * fz * z).toFixed(2) : "";
      }
    </script>

    <script>
      function addTool() {
        const toolNo = document.getElementById("toolNo").value || '99', spindleSpeed = document.getElementById("n").value || '';
        const gcode = [`G90 G17 G21 G49 G80`, `T${toolNo} M06`, `S${spindleSpeed} M03`, `M08`].join('\n');
        const sys = (document.getElementById("gcode").value || 'G54').trim();
        document.getElementById("result").value += `${gcode}\n${sys}\n\n`;
      }

      // --- ▼▼▼ 修改：clearOutput 函數 ▼▼▼ ---
      function clearOutput() {
        document.getElementById("result").value = "";
        document.getElementById('machiningTimeResult').textContent = '';
        cumulativeMachiningTimeInSeconds = 0; // 將累計時間歸零
      }
      // --- ▲▲▲ 修改：clearOutput 函數 ▲▲▲ ---

      function exportToFile() {
        let content = document.getElementById("result").value || "";
        if (content && !content.endsWith('\n')) content += '\n';
        // 恢復您原始的 G-code 結尾
        const footer = ['M05', 'M09', 'G91 G28 Z0.', 'G91 G28 Y0.', 'M30'].join('\n');
        content += footer + '\n';
        const mode = window.currentMode || 'Mode1', ts = new Date().toISOString().replace(/[:.]/g, '-');
        const a = document.createElement("a");
        a.href = URL.createObjectURL(new Blob([content], { type: "text/plain" }));
        a.download = `NC_Helix_Drill_${mode}_${ts}.txt`;
        document.body.appendChild(a);
        a.click();
        setTimeout(() => { URL.revokeObjectURL(a.href); document.body.removeChild(a); }, 0);
      }
      function countClick() { }
    </script>

    <script>
      (function () {
        // fz 閃爍功能的所有程式碼都放在這裡
        const fz = document.getElementById('fz');
        let timer = null; // <--- 這個 'timer' 變數被關在小房間裡

        function shouldBlink() {
          const fzVal = parseFloat(fz.value); const isFzMissing = isNaN(fzVal) || fzVal <= 0;
          const hasN = parseFloat(document.getElementById('n').value) > 0;
          return isFzMissing && hasN;
        }
        function sync() { if (shouldBlink()) { if (!timer) timer = setInterval(() => fz.classList.toggle('blink'), 650); } else { if (timer) { clearInterval(timer); timer = null; } fz.classList.remove('blink'); } }

        window.syncFzBlink = sync; // 唯一對外開放的窗戶

        fz.addEventListener('input', sync);
        document.addEventListener('DOMContentLoaded', sync);
      })();
    </script>


    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const pairs = [
          // group1
          ['preBoreCe1', 'preBore1'],
          ['machiningDiaCe1', 'machiningDia1'],
          ['depthDiaCe1', 'depthDia1'],
          ['pitchCe1', 'pitch1'],
          // group2
          ['preBoreCe2', 'preBore2'],
          ['machiningDiaCe2', 'machiningDia2'],
          ['depthDiaCe2', 'depthDia2'],
          ['pitchCe2', 'pitch2'],
          // group3（新增）
          ['preBoreCe3', 'preBore3'],
          ['machiningDiaCe3', 'machiningDia3'],
          ['depthDiaCe3', 'depthDia3'],
          ['pitchCe3', 'pitch3'],
        ];

        pairs.forEach(([btnId, fieldId]) => {
          const btn = document.getElementById(btnId);
          if (!btn) return;
          btn.addEventListener('click', () => {
            const el = document.getElementById(fieldId);
            if (el) {
              el.value = '';
              el.dispatchEvent(new Event('input', { bubbles: true }));
              el.focus();
            }
            // 清空時即時重算建議值（走 active mode 適配器）
            if (typeof updateSuggestedParameters_forActiveMode === 'function') {
              updateSuggestedParameters_forActiveMode();
            }
          });
        });
      });
    </script>


    <script>
      const imagesByMode = {
        Mode1: "https://nine9.jic-tools.com.tw/upload_files/technology/NC_Helix_Drill/icon_helix_fig.01.jpg",
        Mode2: "https://nine9.jic-tools.com.tw/upload_files/technology/NC_Helix_Drill/icon_helix_fig.02.jpg",
        Mode3: "https://nine9.jic-tools.com.tw/upload_files/technology/NC_Helix_Drill/icon_helix_fig.02.jpg"
      };

      const imgEl = document.getElementById("galleryImg");
      const modeBtns = document.querySelectorAll(".mode-btn");
      const group1 = document.getElementById("group1");
      const group2 = document.getElementById("group2");
      const group3 = document.getElementById("group3");

      let currentMode = 'Mode1';

      function setMode(mode) {
        currentMode = mode;

        // 圖片
        if (imgEl) imgEl.src = imagesByMode[mode] || imagesByMode.Mode1;

        // 按鈕樣式
        modeBtns.forEach(b => {
          const active = (b.dataset.mode === mode);
          b.classList.toggle("btn-primary", active);
          b.classList.toggle("btn-outline-primary", !active);
        });

        // 版面顯示：
        // Mode1 → 只看 group1（全寬）
        // Mode2 → group1 + group2（各半，跟你原本一樣）
        // Mode3 → 只看 group3（全寬，布局與 Mode1 相同）
        if (mode === 'Mode1') {
          group1?.classList.remove('d-none');
          group3?.classList.add('d-none');
          group2?.classList.add('d-none');
          group1?.classList.add('col-12');
          group1?.classList.remove('col-md-6');
        } else if (mode === 'Mode2') {
          group1?.classList.remove('d-none');
          group2?.classList.remove('d-none');
          group3?.classList.add('d-none');
          group1?.classList.remove('col-12');
          group1?.classList.add('col-md-6');
        } else if (mode === 'Mode3') {
          group3?.classList.remove('d-none');
          group1?.classList.add('d-none');
          group2?.classList.add('d-none');
          group3?.classList.add('col-12');
          group3?.classList.remove('col-md-6');
        }

        // 隱藏的 group 值清空
        const clearGroup = (ids) => ids.forEach(id => {
          const el = document.getElementById(id);
          if (el) {
            el.value = '';
            el.dispatchEvent(new Event('input', { bubbles: true }));
          }
        });
        if (mode === 'Mode1') clearGroup(['preBore2', 'machiningDia2', 'depthDia2', 'pitch2', 'preBore3', 'machiningDia3', 'depthDia3', 'pitch3']);
        if (mode === 'Mode2') clearGroup(['preBore3', 'machiningDia3', 'depthDia3', 'pitch3']);
        if (mode === 'Mode3') clearGroup(['preBore1', 'machiningDia1', 'depthDia1', 'pitch1', 'preBore2', 'machiningDia2', 'depthDia2', 'pitch2']);

        // 模式提示（若有 i18n）
        const hint = document.getElementById("modeHint");
        if (hint && window.LangCtl?.get) {
          hint.textContent = window.LangCtl.get(`form.modeDesc.${mode.toLowerCase()}`, '');
        }

        // 走適配器計算（確保 Mode3 也能吃到建議值）
        if (typeof updateSuggestedParameters_forActiveMode === 'function') {
          updateSuggestedParameters_forActiveMode();
        }
      }

      // 綁定
      modeBtns.forEach(btn => btn.addEventListener('click', () => setMode(btn.dataset.mode)));
      setMode('Mode1');
    </script>



    <script>
      // 累計總時間 (移到全域)
      let cumulativeMachiningTimeInSeconds = 0;

      function calculateGCode() {
        const mode = currentMode || 'Mode1';
        const out = [], result = document.getElementById('result');
        const timeResultEl = document.getElementById('machiningTimeResult');

        let currentOperationDistance = 0; // 只計算當前這次操作的路徑

        const num = id => { const v = parseFloat(document.getElementById(id)?.value); return isNaN(v) ? null : v; };
        const txt = id => (document.getElementById(id)?.value ?? "").trim();
        const fmt = (v, dec = 3) => (v == null || isNaN(v)) ? '-' : (+v).toFixed(dec);

        const toolNo = txt('toolNo') || '99', sys = txt('gcode') || 'G54', x0 = num('x') ?? 0, y0 = num('y') ?? 0, zsafe = num('zsafe') ?? 20, zsurf = num('zsurface') ?? 0, Dc = num('toolDiameter'), Vc = num('vc'), N = num('n'), Zteeth = num('z'), Fz = num('fz');
        let Vf = num('vf');
        if ((Vf == null || isNaN(Vf)) && N && Fz && Zteeth) { Vf = N * Fz * Zteeth; }

        // --- ▼▼▼ 新增：安全驗證 ▼▼▼ ---
        if (Dc == null || Dc <= 0) {
          alert("安全錯誤：\n請先從上方選擇一個有效的「Part No. (刀具料號)」。");
          return;
        }
        if (N == null || Vf == null || Fz == null || Vc == null) {
          alert("安全錯誤：\n請確保 Vc, fz, N, Vf 都有正確的數值。");
          return;
        }

        const machiningDia1 = num('machiningDia1');
        const depth1 = num('depthDia1');
        const pitch1 = num('pitch1');

        if (mode === 'Mode1') {
          if (machiningDia1 == null || machiningDia1 <= Dc) {
            alert(`安全錯誤 (Mode1)：\n加工孔徑 (Machining Diameter)「${fmt(machiningDia1, 3)}」\n必須大於刀具直徑 (Tool Diameter)「${fmt(Dc, 3)}」。`);
            return;
          }
          if (depth1 == null || depth1 <= 0 || pitch1 == null || pitch1 <= 0) {
            alert("安全錯誤 (Mode1)：\n請輸入有效的「Depth (深度)」和「Pitch (螺距)」。");
            return;
          }
        }

        const machiningDia2 = num('machiningDia2');
        const depth2 = num('depthDia2');
        const pitch2 = num('pitch2');

        if (mode === 'Mode2') {
          if (machiningDia1 == null || machiningDia1 <= Dc) {
            alert(`安全錯誤 (Mode2 - Step1)：\n加工孔徑 (Machining Diameter)「${fmt(machiningDia1, 3)}」\n必須大於刀具直徑 (Tool Diameter)「${fmt(Dc, 3)}」。`);
            return;
          }
          if (machiningDia2 == null || machiningDia2 <= Dc) {
            alert(`安全錯誤 (Mode2 - Step2)：\n加工孔徑 (Machining Diameter)「${fmt(machiningDia2, 3)}」\n必須大於刀具直徑 (Tool Diameter)「${fmt(Dc, 3)}」。`);
            return;
          }
          if (depth1 == null || depth1 <= 0 || pitch1 == null || pitch1 <= 0 || depth2 == null || depth2 <= 0 || pitch2 == null || pitch2 <= 0) {
            alert("安全錯誤 (Mode2)：\n請為 Step1 和 Step2 輸入有效的「Depth (深度)」和「Pitch (螺距)」。");
            return;
          }
        }

        if (mode === 'Mode3') {
          // 取 group3 數值
          const machiningDia3 = num('machiningDia3');
          const preBore3 = num('preBore3');
          // 可選：若也需要檢查深度/螺距可再取
          // const depth3 = num('depthDia3');
          // const pitch3 = num('pitch3');

          // 基本檢查
          if (machiningDia3 == null || preBore3 == null) {
            alert("安全錯誤 (Mode3)：\n請輸入「Machining Diameter (加工孔徑)」與「Pre-bore diameter (預鑽孔徑)」。");
            return;
          }
          if (preBore3 >= machiningDia3) {
            alert(`安全錯誤 (Mode3)：\n預鑽孔徑必須小於加工孔徑。\nPre-bore = ${fmt(preBore3, 3)}，Machining = ${fmt(machiningDia3, 3)}`);
            return;
          }

          // 計算 Δ(直徑差) 與 Ae(半徑吃刀量)
          const diff = machiningDia3 - preBore3; // Δ：直徑方向
          const radialAe = diff / 2;                 // Ae：半徑方向

          const partNo = getSelectedPartNo();
          const maxDelta = PART_TO_MAX_AE?.[partNo]; // 解讀為「直徑方向允許最大 Δ」
          const minAe = PART_TO_MIN_AE?.[partNo]; // 解讀為「半徑方向允許最小 Ae」

          // 下限：Ae ≥ Min.Ae（若有設定）
          if (Number.isFinite(minAe) && radialAe < minAe) {
            alert(`安全錯誤 (Mode3)：\n半徑側切量 Ae（Δ/2）需 ≥ 最小允許值。\nAe = ${fmt(radialAe, 3)} mm，Min.Ae = ${fmt(minAe, 3)} mm`);
            return;
          }

          // 上限：Δ ≤ MaxΔ（若有設定），否則退回 Δ ≤ Dc
          if (Number.isFinite(maxDelta)) {
            if (radialAe > maxDelta) {
              alert(`安全錯誤 (Mode3)：\n直徑方向吃刀差 Δ 不可超過 MaxΔ。\nΔ = ${fmt(radialAe, 3)} mm，MaxΔ = ${fmt(maxDelta, 3)} mm`);
              return;
            }
          } else {
            if (diff > Dc) {
              alert(`安全錯誤 (Mode3)：\n「加工孔徑 − 預鑽孔徑」需 ≤ 刀具直徑。\nΔ = ${fmt(diff, 3)} mm，Dc = ${fmt(Dc, 3)} mm（需滿足 Δ ≤ Dc）`);
              return;
            }
          }

          // （如也要檢查深度/螺距）
          // if (depth3 == null || depth3 <= 0 || pitch3 == null || pitch3 <= 0) {
          //   alert("安全錯誤 (Mode3)：\n請輸入有效的「Depth (深度)」與「Pitch (螺距)」。");
          //   return;
          // }
        }







        // --- ▲▲▲ 驗證結束 ▲▲▲ ---


        out.push(`(=== NC Helix Drill / ${mode} ===)`);
        out.push(`(PartNo: ${getSelectedPartNo()})`);
        out.push(`(Tool Dc=${fmt(Dc, 3)} mm, Vc=${fmt(Vc, 1)} m/min, N=${fmt(N, 0)} rpm, z=${fmt(Zteeth, 0)}, fz=${fmt(Fz, 3)} mm/tooth, Vf=${fmt(Vf, 1)} mm/min)`);
        out.push(`${sys} G00 X${fmt(x0, 3)} Y${fmt(y0, 3)} `);
        out.push(`G43 H${toolNo} Z${fmt(zsafe, 3)} `);

        // 內部函數：建立螺旋 G-Code 並計算路徑長度
        function buildHelixSection(label, machiningDia, depth, pitch) {
          let sectionDistance = 0;
          if (machiningDia == null || depth == null || pitch == null) return { gcode: [`(WARN) ${label}: missing required fields, skipped.`], distance: 0 };

          const block = [], R = (machiningDia - Dc) / 2, steps = Math.max(1, Math.ceil(depth / pitch)), effPitch = depth / steps;
          block.push(`(--- ${label} ---)`, `(Target Ø=${fmt(machiningDia, 3)}; Depth L=${fmt(depth, 3)}; Pitch=${fmt(pitch, 3)}; R=${fmt(R, 3)})`, `G00 Z${fmt(zsurf + 2, 3)} `);

          if (R > 1e-4) {
            block.push(`G01 X${fmt(x0 + R, 3)} Z${fmt(zsurf, 3)} F${fmt(Vf || 200, 1)} `);
            sectionDistance += Math.sqrt(R * R + 4); // 假設 Z 從 +2 下到 0

            let currentZ = zsurf;
            for (let i = 1; i <= steps; i++) {
              let targetZ = zsurf - (i * effPitch);
              if (i === steps) targetZ = zsurf - depth; // 確保最後一刀在正確深度

              block.push(`G03 I${fmt(-R, 3)} Z${fmt(targetZ, 3)} F${fmt(Vf || 200, 1)} `);
              let zMove = Math.abs(targetZ - currentZ);
              sectionDistance += Math.sqrt(Math.pow(2 * Math.PI * R, 2) + Math.pow(zMove, 2)); // 螺旋線長
              currentZ = targetZ;
            }
          }
          block.push(`G03 I${fmt(-R, 3)} F${fmt(Vf || 200, 1)} (Make one more turn at bottom)`);
          sectionDistance += 2 * Math.PI * R; // 底部清銑一圈

          block.push(`G01 X${fmt(x0, 3)} Y${fmt(y0, 3)} F${fmt(Vf || 200, 1)} (Back to center)`);
          sectionDistance += R; // 回到中心

          block.push(`G00 Z${fmt(zsafe, 3)} `);
          return { gcode: block, distance: sectionDistance };
        }

        if (mode === 'Mode1') {
          const section = buildHelixSection('Mode1', num('machiningDia1'), num('depthDia1'), num('pitch1'));
          out.push(...section.gcode);
          currentOperationDistance += section.distance;
        } else if (mode === 'Mode2') {
          const section1 = buildHelixSection('Mode2_Step1', num('machiningDia1'), num('depthDia1'), num('pitch1'));
          out.push(...section1.gcode);
          currentOperationDistance += section1.distance;
          const section2 = buildHelixSection('Mode2_Step2', num('machiningDia2'), num('depthDia2'), num('pitch2'));
          out.push(...section2.gcode);
          currentOperationDistance += section2.distance;
        } else if (mode === 'Mode3') {
          const section3 = buildHelixSection(
            'Mode3',
            num('machiningDia3'),
            num('depthDia3'),
            num('pitch3')
          );
          out.push(...section3.gcode);
          currentOperationDistance += section3.distance;
        }

        out.push(`(=== End ===)`);
        if (result.value && !result.value.endsWith('\n')) result.value += '\n';
        result.value += out.join('\n') + '\n\n';
        result.scrollTop = result.scrollHeight;

        // 計算並累加時間
        if (Vf > 0 && currentOperationDistance > 0) {
          const timeForThisOperation = (currentOperationDistance / Vf) * 60;
          cumulativeMachiningTimeInSeconds += timeForThisOperation; // 將本次時間累加到總時間上

          const timeTemplate = LangCtl.get('form.results.machiningTime', 'Estimated Total Time: {time} sec');
          timeResultEl.textContent = timeTemplate.replace('{time}', cumulativeMachiningTimeInSeconds.toFixed(2)); // 顯示累計後的總時間
          timeResultEl.classList.remove('text-muted');
          timeResultEl.classList.add('text-primary');
        }
      }
    </script>
  </section>

  <footer class="site-footer">
    <div class="footer-topbar"></div>
    <div class="container py-5">
      <div class="row gy-4 align-items-start">
        <div class="col-12 col-md-6 col-lg-3 text-center">
          <img src="https://nine9.jic-tools.com.tw/upload_files/technology/NC_Program/Jimmore_footer_logo.png"
            alt="JIMMORE" class="footer-logo mb-3 mx-auto d-block">
          <div class="badge-row mb-3">
            <img src="https://nine9.jic-tools.com.tw/upload_files/technology/NC_Program/Jimmore_footer-iso_01.png"
              alt="SGS">
            <img src="https://nine9.jic-tools.com.tw/upload_files/technology/NC_Program/Jimmore_footer-iso_02.png"
              alt="SGS">
            <img src="https://nine9.jic-tools.com.tw/upload_files/technology/NC_Program/Jimmore_footer-iso_03.png"
              alt="UKAS">
          </div>
          <a href="#" target="_blank" rel="noopener">
            <img src="https://www.jic-tools.com.tw/themes/jictools2/images/Jimmore-footer-iso_2.png"
              alt="D-U-N-S Certified" class="duns-img">
          </a>
        </div>
        <div class="col-12 col-md-6 col-lg-3">
          <div class="footer-underline"></div>
          <address class="mb-0 small lh-lg">
            No.120-2, Sec-2 Fusing Rd., South District,<br>Taichung City 402014, Taiwan
          </address>
        </div>
        <div class="col-12 col-md-6 col-lg-3">
          <div class="footer-underline"></div>
          <p class="small mb-2">
            TEL: <a href="tel:+886422605352" class="link-light text-decoration-none">+886-4-22605352</a><br>
            FAX: +886-4-22608765<br>
            E-mail:
            <a href="mailto:trade@jimmore.com.tw" class="link-light text-decoration-none">trade@jimmore.com.tw</a>
          </p>
        </div>
        <div class="col-12 col-md-6 col-lg-3">
          <div class="footer-underline"></div>
          <p class="small mb-2">
            Copyright © <span id="year"></span> Jimmore International Corp.<br>
            All Rights Reserved.
          </p>
          <ul class="list-unstyled small mb-0"></ul>
        </div>
      </div>
    </div>
    <script>
      document.getElementById('year').textContent = (new Date()).getFullYear();
    </script>
  </footer>

  <button type="button" class="btn btn-dark btn-lg rounded-circle " id="backToTopBtn" title="回到頂部">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-arrow-up"
      viewBox="0 0 16 16">
      <path fill-rule="evenodd"
        d="M8 15a.5.5 0 0 0 .5-.5V2.707l3.146 3.147a.5.5 0 0 0 .708-.708l-4-4a.5.5 0 0 0-.708 0l-4 4a.5.5 0 1 0 .708.708L7.5 2.707V14.5a.5.5 0 0 0 .5.5z" />
    </svg>
  </button>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://ulysses-li.github.io/Nine-9/Helix/js/lang-control.v3.js"></script>
  <script src="https://ulysses-li.github.io/Nine-9/Helix/js/interactive.js"></script>
  <!-- <script src="https://ulysses-li.github.io/Nine-9/Helix/js/lang-control.js"></script>
  <script src="https://ulysses-li.github.io/Nine-9/Helix/js/interactive.js"></script> -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // 綁定主軸功率選單
      const powerSelect = document.getElementById('selectPower');
      if (powerSelect) {
        powerSelect.addEventListener('change', updateSuggestedParameters);
      }
    });
  </script>
  <!-- <script src="lang-control.v3.js"></script> -->
</body>

</html>
