<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbzbjC0eT3XW1RStUf3mkI7EvJD7yZ3_w8MG1Tw8yt7P_UHds4KrhVahHzi3r6djyYiH/exec";

  document.getElementById('yy').textContent = new Date().getFullYear();
  const f = document.getElementById('f');
  const msg = document.getElementById('msg');

  function showMsg(type, text) {
    msg.className = `alert alert-${type}`;
    msg.textContent = text;
  }

  async function callApi(payload) {
    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body: JSON.stringify(payload)
    });
    const text = await res.text();
    try { return JSON.parse(text); }
    catch { return { ok: false, message: "回傳不是 JSON：" + text }; }
  }

  f.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!f.checkValidity()) { f.classList.add('was-validated'); return; }

    showMsg("info", "登入中…");

    const payload = {
      action: "login",
      username: document.getElementById('username').value.trim(),
      password: document.getElementById('password').value
    };

    try {
      const data = await callApi(payload);
      if (data && data.ok) {
        showMsg("success", data.message || "登入成功！");
        // ✅ 你可在這裡存 token / 使用者資料
        localStorage.setItem("user", JSON.stringify(data.data || {}));
        // setTimeout(() => window.location.href = "index.html", 500);
      } else {
        showMsg("danger", (data && data.message) || "登入失敗");
      }
    } catch (err) {
      showMsg("danger", (err && err.message) ? err.message : "登入失敗（可能是 CORS / 網路問題）");
    }
  });
</script>
